{"ast":null,"code":"import { HttpHeaders } from '@angular/common/http';\nimport { environment } from '../../environments/environment';\nimport { BehaviorSubject, Subject } from 'rxjs';\nimport { map } from 'rxjs/operators';\nimport { MessageRequest } from \"../_dtos/chat/MessageRequest\";\nimport { NbMessage } from \"../_dtos/chat/NbMessage\";\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"@angular/common/http\";\nimport * as i2 from \"./friend.service\";\nimport * as i3 from \"./token-storage.service\";\nimport * as i4 from \"./notification.service\";\nlet ChatService = /*#__PURE__*/(() => {\n  class ChatService {\n    constructor(httpClient, friendService, storage, notificationService) {\n      this.httpClient = httpClient;\n      this.friendService = friendService;\n      this.storage = storage;\n      this.notificationService = notificationService;\n      this._fetch = new BehaviorSubject(0);\n      this.fetch = this._fetch.asObservable();\n      this.myNbMessages = new Subject();\n      this.httpOptions = {\n        headers: new HttpHeaders({\n          'Content-Type': 'application/json'\n        })\n      };\n      this.fileOptions = {\n        headers: new HttpHeaders({\n          'Content-Type': 'multipart/form-data'\n        })\n      };\n      this.httpOptions.headers = new HttpHeaders({\n        'Content-Type': 'application/json',\n        'Authorization': 'Bearer ' + this.storage.getToken()\n      });\n      this.nbMessages = this.myNbMessages.asObservable();\n    }\n    updateMessage(userMessages) {\n      let dataMessage = userMessages.map(m => {\n        return new NbMessage(m);\n      });\n      this.myNbMessages.next(dataMessage);\n      this.friendService.sortFriends();\n    }\n    updateFetch(value) {\n      this._fetch.next(value);\n    }\n    fetchMessages(id) {\n      return this.httpClient.get(`${environment.DOMAIN}/api/chat/${id}/messages`, this.httpOptions).pipe(map(msgs => {\n        this.updateMessage(msgs);\n        return msgs;\n      }));\n    }\n    createMessage(messageRequest, files) {\n      let messageId;\n      if (files.length != 0) {\n        let formData = new FormData();\n        formData.append('files', files);\n        formData.append('chatId', messageRequest.chatId + \"\");\n        this.createMessageFile(formData).subscribe({\n          next: v => {\n            messageId = v.id;\n          },\n          error: err => {\n            console.log(\"err-createMessageFile\", err);\n          }\n        });\n      }\n      this.notificationService.sendMessage(new MessageRequest(messageRequest.chatId, messageRequest.content, messageId ? messageId : null));\n    }\n    createMessageFile(data) {\n      return this.httpClient.post(`${environment.DOMAIN}/api/chat/messages/files`, data, this.fileOptions).pipe(map(v => {\n        return v;\n      }));\n    }\n  }\n  ChatService.ɵfac = function ChatService_Factory(t) {\n    return new (t || ChatService)(i0.ɵɵinject(i1.HttpClient), i0.ɵɵinject(i2.FriendService), i0.ɵɵinject(i3.TokenStorageService), i0.ɵɵinject(i4.NotificationService));\n  };\n  ChatService.ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n    token: ChatService,\n    factory: ChatService.ɵfac\n  });\n  return ChatService;\n})();\nexport { ChatService };","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}